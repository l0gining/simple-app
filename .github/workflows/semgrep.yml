name: SAST - Semgrep

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest

    container:
      image: semgrep/semgrep

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: semgrep scan --config auto --json --output semgrep-report.json

      - name: Upload Semgrep report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: semgrep-sast-report
          path: semgrep-report.json

      - name: Check for critical/high findings
        run: |
          if [ -f semgrep-report.json ]; then
            # Count high and critical severity findings
            critical=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-report.json)

            echo "====== SAST Results ======"
            echo "Critical/High severity issues: $critical"

            if [ "$critical" -gt 0 ]; then
              echo ""
              echo "❌ SAST Quality Gate FAILED"
              echo ""
              echo "Findings:"
              jq -r '.results[] | select(.extra.severity == "ERROR") | "[\(.extra.severity)] \(.check_id)\n  File: \(.path):\(.start.line)\n  Message: \(.extra.message)\n"' semgrep-report.json
              exit 1
            else
              echo "✅ SAST Quality Gate PASSED"
            fi
          fi

